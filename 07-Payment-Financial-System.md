# نظام الدفع والمالية (Payment & Financial System)

---

## Executive Summary

يُعد نظام الدفع والمالية العمود الفقري للعمليات المالية في منصة حجز الباصات متعددة البائعين، حيث يتولى مسؤولية معالجة جميع المعاملات المالية بين الأطراف المختلفة (العملاء، المكاتب، المنصة). يضمن هذا النظام أمان وسلاسة عمليات الدفع، ويوفر مرونة في خيارات الدفع، ويدير العمليات المالية المعقدة في بيئة تشغيلية متنوعة.

في سياق السوق اليمني والسعودي، يواجه النظام تحديات فريدة تتمثل في تنوع خيارات الدفع المتاحة، والحاجة إلى دعم العملات المختلفة (الريال اليمني، الريال السعودي)، وضمان الامتثال للمعايير المالية والأمنية في كلا البلدين.

---

## Business Objectives

### الأهداف الاستراتيجية

| الهدف | الوصف | المؤشر |
|-------|-------|--------|
| تبسيط الدفع | جعل عملية الدفع سهلة وآمنة | معدل إتمام الدفع |
| تنوع الخيارات | دعم طرق دفع متعددة | عدد طرق الدفع |
| ضمان الأمان | حماية البيانات المالية | نسبة الاحتيال |
| الكفاءة المالية | تقليل تكاليف المعاملات | تكلفة المعاملة |

### الأهداف التشغيلية

1. **الموثوقية**: ضمان نجاح المعاملات المالية
2. **السرعة**: تقليل وقت معالجة الدفع
3. **الشفافية**: توفير سجل كامل للمعاملات
4. **المرونة**: دعم سيناريوهات دفع مختلفة

---

## Scope

### داخل النطاق

```
┌─────────────────────────────────────────────────────────────────┐
│                 نطاق نظام الدفع والمالية                          │
├─────────────────────────────────────────────────────────────────┤
│  ✓ معالجة المدفوعات (Payment Processing)                        │
│  ✓ بوابات الدفع (Payment Gateways)                              │
│  ✓ المحافظ الإلكترونية (Digital Wallets)                        │
│  ✓ الدفع عند الاستلام (Cash on Delivery)                        │
│  ✓ الدفع البنكي (Bank Transfer)                                 │
│  ✓ إدارة العملات (Currency Management)                          │
│  ✓ الفواتير والإيصالات (Invoicing & Receipts)                   │
│  ✓ معالجة الاسترداد (Refund Processing)                         │
│  ✓ سجل المعاملات (Transaction Log)                              │
│  ✓ الكشوفات المالية (Financial Statements)                      │
│  ✓ إدارة الرصيد (Balance Management)                            │
│  ✓ التحويلات للمكاتب (Vendor Payouts)                           │
└─────────────────────────────────────────────────────────────────┘
```

### خارج النطاق

- التحويلات الدولية الكبرى
- خدمات التمويل والتقسيط
- الاستثمارات المالية

---

## Detailed Functional Requirements

### FR-PF-001: معالجة المدفوعات

| المعرف | المتطلب | الأولوية | التفاصيل |
|--------|---------|----------|----------|
| FR-PF-001-01 | بدء عملية الدفع | حرجة | من صفحة الحجز |
| FR-PF-001-02 | اختيار طريقة الدفع | حرجة | عرض الخيارات المتاحة |
| FR-PF-001-03 | التحقق من الرصيد | حرجة | للمحافظ الإلكترونية |
| FR-PF-001-04 | معالجة الدفع | حرجة | التواصل مع بوابة الدفع |
| FR-PF-001-05 | تأكيد الدفع | حرجة | استلام تأكيد من البوابة |
| FR-PF-001-06 | فشل الدفع | حرجة | معالجة الفشل وإشعار العميل |

### FR-PF-002: بوابات الدفع

| المعرف | المتطلب | الأولوية | التفاصيل |
|--------|---------|----------|----------|
| FR-PF-002-01 | تكامل مع بوابات محلية | حرجة | بوابات يمنية وسعودية |
| FR-PF-002-02 | تكامل مع Stripe | عالية | للبطاقات الدولية |
| FR-PF-002-03 | تكامل مع PayPal | متوسطة | خيار إضافي |
| FR-PF-002-04 | إدارة عدة بوابات | حرجة | تبديل بين البوابات |
| FR-PF-002-05 | التحقق من حالة البوابة | حرجة | التأكد من توفر البوابة |

### FR-PF-003: المحافظ الإلكترونية

| المعرف | المتطلب | الأولوية | التفاصيل |
|--------|---------|----------|----------|
| FR-PF-003-01 | إنشاء محفظة | عالية | لكل عميل |
| FR-PF-003-02 | شحن المحفظة | عالية | إضافة رصيد |
| FR-PF-003-03 | الدفع من المحفظة | عالية | خصم الرصيد |
| FR-PF-003-04 | سجل المحفظة | عالية | جميع العمليات |
| FR-PF-003-05 | حدود المحفظة | عالية | حد أقصى للرصيد |

### FR-PF-004: الدفع عند الاستلام

| المعرف | المتطلب | الأولوية | التفاصيل |
|--------|---------|----------|----------|
| FR-PF-004-01 | تفعيل خيار الدفع عند الاستلام | عالية | حسب سياسة المكتب |
| FR-PF-004-02 | تأمين الحجز | عالية | حجز مؤقت حتى الدفع |
| FR-PF-004-03 | تأكيد الدفع النقدي | حرجة | من قبل المكتب |
| FR-PF-004-04 | سجل الدفع النقدي | حرجة | تسجيل في النظام |

### FR-PF-005: الدفع البنكي

| المعرف | المتطلب | الأولوية | التفاصيل |
|--------|---------|----------|----------|
| FR-PF-005-01 | عرض تفاصيل الحساب | عالية | للتحويل البنكي |
| FR-PF-005-02 | رفع إيصال التحويل | عالية | صورة الإيصال |
| FR-PF-005-03 | التحقق من التحويل | حرجة | مراجعة يدوية |
| FR-PF-005-04 | تأكيد الدفع | حرجة | بعد التحقق |

### FR-PF-006: إدارة العملات

| المعرف | المتطلب | الأولوية | التفاصيل |
|--------|---------|----------|----------|
| FR-PF-006-01 | دعم الريال اليمني | حرجة | العملة المحلية |
| FR-PF-006-02 | دعم الريال السعودي | حرجة | للرحلات الدولية |
| FR-PF-006-03 | تحويل العملات | عالية | حسب سعر الصرف |
| FR-PF-006-04 | عرض الأسعار | حرجة | بالعملة المناسبة |
| FR-PF-006-05 | تحديث أسعار الصرف | عالية | دورياً |

### FR-PF-007: الفواتير والإيصالات

| المعرف | المتطلب | الأولوية | التفاصيل |
|--------|---------|----------|----------|
| FR-PF-007-01 | إنشاء فاتورة | حرجة | لكل عملية دفع |
| FR-PF-007-02 | رقم الفاتورة | حرجة | معرف فريد |
| FR-PF-007-03 | تفاصيل الفاتورة | حرجة | جميع البيانات |
| FR-PF-007-04 | إرسال الفاتورة | حرجة | عبر البريد/الواتساب |
| FR-PF-007-05 | سجل الفواتير | حرجة | أرشيف كامل |

### FR-PF-008: الاسترداد

| المعرف | المتطلب | الأولوية | التفاصيل |
|--------|---------|----------|----------|
| FR-PF-008-01 | معالجة الاسترداد | حرجة | عند الإلغاء |
| FR-PF-008-02 | حساب المبلغ | حرجة | حسب سياسة الاسترداد |
| FR-PF-008-03 | طريقة الاسترداد | حرجة | نفس طريقة الدفع |
| FR-PF-008-04 | وقت الاسترداد | حرجة | حسب الطريقة |
| FR-PF-008-05 | تأكيد الاسترداد | حرجة | إشعار للعميل |

---

## Non-Functional Requirements

### NFR-PF-001: الأداء

| المعرف | المتطلب | القيمة |
|--------|---------|--------|
| NFR-PF-001-01 | وقت معالجة الدفع | < 5 ثوانٍ |
| NFR-PF-001-02 | وقت الاسترداد | < 24 ساعة |
| NFR-PF-001-03 | عدد المعاملات المتزامنة | 1000+ |

### NFR-PF-002: الأمان

| المعرف | المتطلب | الأولوية |
|--------|---------|----------|
| NFR-PF-002-01 | تشفير البيانات | حرجة (PCI DSS) |
| NFR-PF-002-02 | عدم تخزين بيانات البطاقة | حرجة |
| NFR-PF-002-03 | مصادقة 3D Secure | حرجة |
| NFR-PF-002-04 | كشف الاحتيال | حرجة |

---

## Use Cases

### UC-PF-001: إتمام دفع

| العنصر | الوصف |
|--------|-------|
| الممثل | العميل |
| الشرط المسبق | وجود حجز مؤكد |
| السيناريو | 1. اختيار طريقة الدفع<br>2. إدخال بيانات الدفع<br>3. معالجة الدفع<br>4. تأكيد الدفع |
| الشرط النهائي | دفع ناجح مع إيصال |

### UC-PF-002: استرداد مبلغ

| العنصر | الوصف |
|--------|-------|
| الممثل | النظام/المشرف |
| الشرط المسبق | إلغاء حجز مؤكد |
| السيناريو | 1. حساب المبلغ المسترد<br>2. معالجة الاسترداد<br>3. إشعار العميل |
| الشرط النهائي | استرداد ناجح |

---

## Actors

| الممثل | الوصف |
|--------|-------|
| العميل | إجراء المدفوعات |
| ممثل المكتب | تأكيد الدفع النقدي |
| المشرف المالي | مراقبة المعاملات |
| بوابة الدفع | معالجة المدفوعات |
| البنك | التحويلات البنكية |

---

## Workflows

### سير عمل الدفع

**المرحلة الأولى: الاختيار**
- عرض خيارات الدفع
- اختيار الطريقة المناسبة

**المرحلة الثانية: المعالجة**
- إرسال طلب الدفع
- التواصل مع البوابة
- انتظار الاستجابة

**المرحلة الثالثة: التأكيد**
- استلام تأكيد الدفع
- تحديث حالة الحجز
- إنشاء الفاتورة

### سير عمل الاسترداد

**المرحلة الأولى: الطلب**
- استلام طلب الاسترداد
- التحقق من صلاحيته

**المرحلة الثانية: الحساب**
- حساب المبلغ المسترد
- تحديد طريقة الاسترداد

**المرحلة الثالثة: التنفيذ**
- معالجة الاسترداد
- إشعار العميل

---

## Data Entities (Conceptual)

| الكيان | الوصف |
|--------|-------|
| Payment | عملية الدفع |
| PaymentMethod | طريقة الدفع |
| Transaction | المعاملة المالية |
| Invoice | الفاتورة |
| Refund | الاسترداد |
| Wallet | المحفظة الإلكترونية |
| WalletTransaction | معاملات المحفظة |
| Currency | العملة |
| ExchangeRate | سعر الصرف |

---

## Business Rules

| المعرف | القاعدة |
|--------|--------|
| BR-PF-001 | كل دفع يجب أن يكون له رقم معاملة فريد |
| BR-PF-002 | يجب تشفير جميع البيانات المالية |
| BR-PF-003 | لا يمكن استرداد أكثر من المبلغ المدفوع |
| BR-PF-004 | يجب إصدار فاتورة لكل عملية دفع |
| BR-PF-005 | الاسترداد لنفس طريقة الدفع |
| BR-PF-006 | يجب التحقق من صحة البطاقة |

---

## Edge Cases

| الحالة | الوصف | المعالجة |
|--------|-------|----------|
| EC-PF-001 | فشل الدفع بعد خصم الرصيد | إرجاع الرصيد |
| EC-PF-002 | دفع مكرر | استرداد تلقائي |
| EC-PF-003 | تعطل بوابة الدفع | التبديل لبوابة بديلة |
| EC-PF-004 | رفض البنك | إشعار العميل بسبب الرفض |
| EC-PF-005 | تأخر الاسترداد | متابعة مع البنك |

---

## Risk Considerations

| المخطر | الاحتمالية | التأثير | الاستراتيجية |
|--------|-----------|---------|--------------|
| الاحتيال | متوسط | عالي | كشف الاحتيال |
| فشل البوابة | منخفض | عالي | بوابات بديلة |
| تقلب العملة | متوسط | متوسط | تحديث يومي |
| تأخر الاسترداد | متوسط | متوسط | SLA واضح |

---

## Future Enhancements

| التحسين | الوصف | الأولوية |
|---------|-------|----------|
| FE-PF-001 | تقسيط الدفع | متوسطة |
| FE-PF-002 | اشتراكات شهرية | منخفضة |
| FE-PF-003 | مكافآت نقدية | متوسطة |
| FE-PF-004 | تحويل دولي مباشر | منخفضة |

---

*تم إعداد هذا الملف بواسطة يونس العفيف - منصة حجز الباصات*
*الإصدار: 1.0*
