# نظام إدارة الهوية والمستخدمين (User Identity Management System)

---

## Executive Summary

يُعد نظام إدارة الهوية والمستخدمين الركيزة الأساسية لضمان الأمان والتحكم في الوصول داخل منصة حجز الباصات متعددة البائعين. يوفر هذا النظام الإطار الشامل لإنشاء الهويات الرقمية، وإدارة عمليات المصادقة والتفويض، وضمان أن كل مستخدم يصل فقط إلى الموارد والوظائف المصرح له بها وفقاً لدوره المحدد.

في سياق المنصة اليمنية، يكتسب هذا النظام أهمية بالغة نظراً للحاجة إلى التعامل مع فئات متنوعة من المستخدمين (عملاء، ممثلي مكاتب، مشرفين) عبر بيئة تشغيلية معقدة تشمل النقل الداخلي والدولي. يضمن النظام حماية البيانات الشخصية والمالية، ويُمكّن من بناء علاقات ثقة مستدامة بين جميع أطراف المنظومة.

---

## Business Objectives

### الأهداف الاستراتيجية

| الهدف | الوصف | المؤشر |
|-------|-------|--------|
| تأمين الوصول | ضمان وصول آمن ومصرح له فقط | نسبة محاولات الاختراق المفحوصة |
| بناء الثقة | إنشاء هويات موثوقة لجميع المستخدمين | نسبة المستخدمين الموثقين |
| تمكين التحكم الدقيق | توفير صلاحيات محددة لكل دور | دقة التحكم في الصلاحيات |
| ضمان الامتثال | الالتزام بمعايير حماية البيانات | نسبة الامتثال للمعايير |

### الأهداف التشغيلية

1. **تبسيط التسجيل**: تسهيل عملية إنشاء الحسابات مع الحفاظ على الأمان
2. **إدارة فعالة للجلسات**: ضمان أمان الجلسات وإدارتها بكفاءة
3. **التحكم الدوري**: تمكين إدارة الصلاحيات بمرونة عالية
4. **المراقبة والتتبع**: تسجيل جميع أنشطة المستخدمين للمراجعة

---

## Scope

### داخل النطاق

```
┌─────────────────────────────────────────────────────────────────┐
│              نطاق نظام إدارة الهوية والمستخدمين                   │
├─────────────────────────────────────────────────────────────────┤
│  ✓ التسجيل وإنشاء الحسابات (Signup & Registration)              │
│  ✓ المصادقة متعددة العوامل (Multi-Factor Authentication)         │
│  ✓ إدارة كلمات المرور (Password Management)                     │
│  ✓ التحكم في الوصول المستند إلى الأدوار (RBAC)                   │
│  ✓ إدارة الجلسات (Session Management)                           │
│  ✓ التحقق من الهوية (Identity Verification)                     │
│  ✓ استرداد الحساب (Account Recovery)                            │
│  ✓ سجل الأنشطة (Activity Logging)                               │
│  ✓ إدارة الملف الشخصي (Profile Management)                      │
│  ✓ التحقق من البريد والهاتف                                     │
└─────────────────────────────────────────────────────────────────┘
```

### خارج النطاق

- التحقق البيومتري المتقدم (بصمة العين، الوجه)
- التكامل مع أنظمة الهوية الحكومية
- إدارة الهوية عبر المنصات الخارجية (Social Login)

---

## Detailed Functional Requirements

### FR-UI-001: التسجيل وإنشاء الحسابات

| المعرف | المتطلب | الأولوية | التفاصيل |
|--------|---------|----------|----------|
| FR-UI-001-01 | تسجيل العملاء | حرجة | إنشاء حساب باسم، بريد، هاتف، كلمة مرور |
| FR-UI-001-02 | تسجيل مكاتب النقل | حرجة | إنشاء حساب مكتب مع بيانات الشركة |
| FR-UI-001-03 | التحقق من البريد الإلكتروني | حرجة | إرسال رابط التحقق |
| FR-UI-001-04 | التحقق من رقم الهاتف | حرجة | إرسال رمز OTP |
| FR-UI-001-05 | قبول الشروط والأحكام | حرجة | إجبارية القبول قبل التسجيل |

### FR-UI-002: المصادقة

| المعرف | المتطلب | الأولوية | التفاصيل |
|--------|---------|----------|----------|
| FR-UI-002-01 | تسجيل الدخول بالبريد/الهاتف | حرجة | دعم كلا الطريقتين |
| FR-UI-002-02 | تذكرني | متوسطة | تمديد مدة الجلسة |
| FR-UI-002-03 | المصادقة متعددة العوامل | عالية | دعم OTP كعامل ثانٍ |
| FR-UI-002-04 | تسجيل الدخول بالبصمة | منخفضة | دعم بصمة الجهاز |
| FR-UI-002-05 | قفل الحساب بعد محاولات فاشلة | حرجة | قفل مؤقت بعد 5 محاولات |

### FR-UI-003: إدارة كلمات المرور

| المعرف | المتطلب | الأولوية | التفاصيل |
|--------|---------|----------|----------|
| FR-UI-003-01 | تعقيد كلمة المرور | حرجة | 8 أحرف على الأقل، أرقام، رموز |
| FR-UI-003-02 | تغيير كلمة المرور | حرجة | مع التحقق من القديمة |
| FR-UI-003-03 | استرداد كلمة المرور | حرجة | عبر البريد أو الهاتف |
| FR-UI-003-04 | إشعار تغيير كلمة المرور | عالية | إشعار عند أي تغيير |
| FR-UI-003-05 | عدم تكرار كلمات المرور | متوسطة | منع استخدام آخر 5 كلمات مرور |

### FR-UI-004: التحكم في الوصول المستند إلى الأدوار (RBAC)

| المعرف | المتطلب | الأولوية | التفاصيل |
|--------|---------|----------|----------|
| FR-UI-004-01 | تعريف الأدوار | حرجة | عميل، ممثل مكتب، مشرف |
| FR-UI-004-02 | تعيين الصلاحيات للأدوار | حرجة | تحديد ما يمكن لكل دور فعله |
| FR-UI-004-03 | تخصيص الصلاحيات | عالية | إمكانية تخصيص لكل مستخدم |
| FR-UI-004-04 | التحقق من الصلاحيات | حرجة | التحقق قبل كل عملية |
| FR-UI-004-05 | سجل التدقيق للصلاحيات | حرجة | تسجيل جميع عمليات الوصول |

### FR-UI-005: إدارة الجلسات

| المعرف | المتطلب | الأولوية | التفاصيل |
|--------|---------|----------|----------|
| FR-UI-005-01 | إنشاء جلسة عند تسجيل الدخول | حرجة | مع رمز JWT آمن |
| FR-UI-005-02 | انتهاء الجلسة تلقائياً | حرجة | بعد 30 دقيقة من عدم النشاط |
| FR-UI-005-03 | جلسة واحدة للجهاز | متوسطة | إنهاء الجلسات السابقة |
| FR-UI-005-04 | عرض الجلسات النشطة | عالية | مع إمكانية إنهائها |
| FR-UI-005-05 | إنهاء جميع الجلسات | عالية | من أي جهاز |

### FR-UI-006: إدارة الملف الشخصي

| المعرف | المتطلب | الأولوية | التفاصيل |
|--------|---------|----------|----------|
| FR-UI-006-01 | عرض الملف الشخصي | حرجة | جميع البيانات الشخصية |
| FR-UI-006-02 | تعديل البيانات الشخصية | عالية | الاسم، الصورة، إلخ |
| FR-UI-006-03 | تغيير البريد/الهاتف | حرجة | مع التحقق من الجديد |
| FR-UI-006-04 | إضافة صورة شخصية | متوسطة | مع التحقق من المحتوى |
| FR-UI-006-05 | عرض سجل الحجوزات | حرجة | جميع الحجوزات السابقة |

---

## Non-Functional Requirements

### NFR-UI-001: الأداء

| المعرف | المتطلب | القيمة |
|--------|---------|--------|
| NFR-UI-001-01 | وقت تسجيل الدخول | < 2 ثانية |
| NFR-UI-001-02 | وقت التسجيل | < 5 ثوانٍ |
| NFR-UI-001-03 | وقت إرسال OTP | < 10 ثوانٍ |
| NFR-UI-001-04 | عدد المستخدمين المتزامنين | 10,000+ |

### NFR-UI-002: الأمان

| المعرف | المتطلب | الأولوية |
|--------|---------|----------|
| NFR-UI-002-01 | تشفير كلمات المرور | حرجة (bcrypt) |
| NFR-UI-002-02 | تشفير البيانات الحساسة | حرجة (AES-256) |
| NFR-UI-002-03 | حماية ضد Brute Force | حرجة |
| NFR-UI-002-04 | حماية ضد Session Hijacking | حرجة |
| NFR-UI-002-05 | التحقق من صحة JWT | حرجة |

### NFR-UI-003: التوفر

| المعرف | المتطلب | القيمة |
|--------|---------|--------|
| NFR-UI-003-01 | نسبة توفر المصادقة | 99.99% |
| NFR-UI-003-02 | وقت التعافي | < 5 دقائق |

---

## Use Cases

### UC-UI-001: تسجيل عميل جديد

| العنصر | الوصف |
|--------|-------|
| الممثل | العميل المحتمل |
| الشرط المسبق | غير مسجل مسبقاً |
| السيناريو | 1. يدخل العميل البيانات المطلوبة<br>2. يقبل الشروط والأحكام<br>3. يستلم رمز OTP<br>4. يدخل رمز التحقق<br>5. يتم إنشاء الحساب |
| الشرط النهائي | حساب نشط جاهز للاستخدام |

### UC-UI-002: تسجيل دخول العميل

| العنصر | الوصف |
|--------|-------|
| الممثل | العميل المسجل |
| الشرط المسبق | حساب نشط وموثق |
| السيناريو | 1. يدخل العميل البريد/الهاتف<br>2. يدخل كلمة المرور<br>3. (اختياري) يدخل رمز MFA<br>4. يتم إنشاء الجلسة |
| الشرط النهائي | جلسة نشطة مع صلاحيات العميل |

### UC-UI-003: تسجيل مكتب نقل

| العنصر | الوصف |
|--------|-------|
| الممثل | مالك مكتب النقل |
| الشرط المسبق | توفر بيانات الشركة |
| السيناريو | 1. يدخل بيانات المكتب<br>2. يرفع المستندات المطلوبة<br>3. ينتظر موافقة الإدارة<br>4. يتم تفعيل الحساب |
| الشرط النهائي | حساب مكتب نشط مع لوحة تحكم |

---

## Actors

| الممثل | الوصف | الأدوار |
|--------|-------|---------|
| العميل (Customer) | المستخدم النهائي للحجز | البحث، الحجز، التقييم |
| ممثل المكتب (Office Rep) | مدير مكتب النقل | إدارة الرحلات، التقارير |
| المشرف العام (Super Admin) | إدارة المنصة | جميع الصلاحيات |
| المشرف المالي (Finance Admin) | إدارة المدفوعات | التقارير المالية |
| المشرف الدعم (Support Admin) | دعم العملاء | عرض البيانات، المساعدة |
| النظام (System) | العمليات الآلية | المصادقة، الإشعارات |

---

## Workflows

### سير عمل التسجيل

**المرحلة الأولى: إدخال البيانات**
- عرض نموذج التسجيل
- التحقق من صحة البيانات المدخلة
- التحقق من عدم وجود حساب مسبق

**المرحلة الثانية: التحقق**
- إرسال رمز OTP للهاتف
- إرسال رابط للبريد الإلكتروني
- انتظار التحقق من كلا القناتين

**المرحلة الثالثة: الإنشاء**
- تشفير كلمة المرور
- إنشاء سجل المستخدم
- تعيين الدور الافتراضي
- إنشاء الجلسة الأولى

### سير عمل المصادقة

**المرحلة الأولى: التحقق من الهوية**
- استلام بيانات الاعتماد
- البحث عن المستخدم
- التحقق من كلمة المرور
- التحقق من حالة الحساب

**المرحلة الثانية: التحقق الثانوي (MFA)**
- إرسال رمز OTP
- انتظار الإدخال
- التحقق من الرمز

**المرحلة الثالثة: إنشاء الجلسة**
- إنشاء رمز JWT
- تسجيل الجلسة
- إرجاع بيانات الجلسة

### سير عمل التحكم في الوصول

**المرحلة الأولى: تحديد الدور**
- استخراج الدور من الجلسة
- جلب الصلاحيات المرتبطة

**المرحلة الثانية: التحقق من الصلاحية**
- مقارنة العملية المطلوبة بالصلاحيات
- السماح أو الرفض

**المرحلة الثالثة: التسجيل**
- تسجيل محاولة الوصول
- في حالة الرفض: تسجيل التفاصيل

---

## Data Entities (Conceptual)

### الكيانات الرئيسية

| الكيان | الوصف | الحقول الرئيسية |
|--------|-------|----------------|
| User | المستخدم الأساسي | id, email, phone, password_hash, status |
| UserProfile | الملف الشخصي | user_id, name, avatar, preferences |
| UserRole | أدوار المستخدم | id, name, description, permissions |
| UserRoleAssignment | تعيين الأدوار | user_id, role_id, assigned_at |
| Permission | الصلاحيات | id, resource, action, description |
| RolePermission | صلاحيات الدور | role_id, permission_id |
| Session | جلسات المستخدم | id, user_id, token, expires_at, device_info |
| LoginAttempt | محاولات الدخول | user_id, ip, status, timestamp |
| PasswordReset | طلبات استرداد | user_id, token, expires_at, used |
| ActivityLog | سجل الأنشطة | user_id, action, resource, timestamp, ip |
| Verification | عمليات التحقق | user_id, type, code, expires_at, verified |

### نموذج البيانات المفاهيمي

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│    User     │────▶│ UserProfile │     │   Session   │
└──────┬──────┘     └─────────────┘     └─────────────┘
       │
       ▼
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│UserRoleAssign│────▶│  UserRole   │────▶│RolePermission│
└─────────────┘     └─────────────┘     └──────┬──────┘
                                               │
                                               ▼
                                        ┌─────────────┐
                                        │  Permission │
                                        └─────────────┘
```

---

## Business Rules

### قواعد التسجيل

| المعرف | القاعدة |
|--------|--------|
| BR-UI-001 | البريد الإلكتروني يجب أن يكون فريداً |
| BR-UI-002 | رقم الهاتف يجب أن يكون فريداً |
| BR-UI-003 | يجب التحقق من البريد قبل تفعيل الحساب |
| BR-UI-004 | يجب التحقق من الهاتف قبل تفعيل الحساب |
| BR-UI-005 | يجب أن تكون كلمة المرور معقدة |

### قواعد المصادقة

| المعرف | القاعدة |
|--------|--------|
| BR-UI-006 | يجب قفل الحساب بعد 5 محاولات فاشلة |
| BR-UI-007 | يجب إشعار المستخدم بمحاولات الدخول المشبوهة |
| BR-UI-008 | يجب إنهاء الجلسة بعد فترة من عدم النشاط |
| BR-UI-009 | يجب عدم السماح بجلسات متعددة من نفس الجهاز |
| BR-UI-010 | يجب تسجيل جميع عمليات المصادقة |

### قواعد الصلاحيات

| المعرف | القاعدة |
|--------|--------|
| BR-UI-011 | لا يمكن للمستخدم تجاوز صلاحيات دوره |
| BR-UI-012 | يجب التحقق من الصلاحية قبل كل عملية |
| BR-UI-013 | يجب تسجيل جميع محاولات الوصول المرفوضة |
| BR-UI-014 | يمكن للمشرف العام منح/سحب الصلاحيات |
| BR-UI-015 | لا يمكن حذف دور به مستخدمون نشطون |

---

## Edge Cases

### الحالات الحدية

| الحالة | الوصف | المعالجة |
|--------|-------|----------|
| EC-UI-001 | تسجيل ببريد موجود | إظهار رسالة: "الحساب موجود، سجل دخول" |
| EC-UI-002 | نسيان كلمة المرور والبريد | التواصل مع الدعم مع التحقق المتقدم |
| EC-UI-003 | عدم استلام OTP | إعادة الإرسال مع تأخير تصاعدي |
| EC-UI-004 | حساب مقفول | عرض خيار فتح الحساب عبر البريد |
| EC-UI-005 | جلسة منتهية أثناء العملية | حفظ البيانات وطلب إعادة الدخول |
| EC-UI-006 | محاولة وصول غير مصرح | تسجيل وإشعار الأمان |
| EC-UI-007 | تغيير دور أثناء جلسة نشطة | إنهاء الجلسة وإعادة الدخول |

---

## Risk Considerations

### المخاطر الأمنية

| المخطر | الاحتمالية | التأثير | الاستراتيجية |
|--------|-----------|---------|--------------|
| اختراق الحسابات | متوسط | حرج | MFA، رصد غير طبيعي |
| Brute Force | عالي | عالي | Rate Limiting، Captcha |
| Session Hijacking | منخفض | حرج | HTTPS، SameSite Cookies |
| Credential Stuffing | متوسط | عالي | فحص كلمات المرور المسربة |

### المخاطر التشغيلية

| المخطر | الاحتمالية | التأثير | الاستراتيجية |
|--------|-----------|---------|--------------|
| فقدان الوصول للجميع | منخفض | حرج | مستخدم طوارئ |
| مشاكل مزود SMS | متوسط | عالي | مزود احتياطي |
| ازدحام التسجيل | متوسط | متوسط | Queue System |

---

## Future Enhancements

| التحسين | الوصف | الأولوية |
|---------|-------|----------|
| FE-UI-001 | تسجيل الدخول بالبصمة | عالية |
| FE-UI-002 | تسجيل الدخول بـ Google/Apple | متوسطة |
| FE-UI-003 | المصادقة بالوجه | منخفضة |
| FE-UI-004 | التحقق من الهوية بالبطاقة | عالية |
| FE-UI-005 | SSO للمكاتب الكبيرة | متوسطة |
| FE-UI-006 | إدارة الهوية الذاتية (Self-Sovereign) | منخفضة |

---

## Appendices

### A. هيكل الأدوار والصلاحيات

| الدور | الصلاحيات |
|-------|----------|
| العميل | عرض الرحلات، الحجز، الدفع، التقييم، إدارة الحجوزات |
| ممثل المكتب | إدارة الرحلات، المقاعد، التقارير، عرض الحجوزات |
| مشرف الدعم | عرض البيانات، حل المشاكل، التواصل مع المستخدمين |
| مشرف مالي | التقارير المالية، المدفوعات، العمولات |
| مشرف عام | جميع الصلاحيات، إدارة المستخدمين، الإعدادات |

---

*تم إعداد هذا الملف بواسطة فريق تحليل الأنظمة - منصة حجز الباصات*
*الإصدار: 1.0*
